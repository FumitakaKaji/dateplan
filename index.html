<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³å…±æœ‰ã‚¢ãƒ—ãƒª</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icons: FontAwesome (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles: Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#1a1614',    
                            primary: '#5D4037', 
                            accent: '#D4AF37',  
                            light: '#EFEBE9',   
                            surface: '#2c2420'  
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #111827;
            color: #E5E7EB;
            -webkit-font-smoothing: antialiased;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes pop { 50% { transform: scale(1.2); } }
        .icon-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .modal-enter { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Loader */
        .loader { border: 2px solid #374151; border-top: 2px solid #D4AF37; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 pb-24 min-h-screen relative overflow-x-hidden selection:bg-brand-accent selection:text-brand-dark">

    <!-- ================= AUTH OVERLAY ================= -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="text-center mb-10">
            <div class="inline-block p-4 rounded-full bg-brand-primary/20 mb-4 border border-brand-accent/30">
                <i class="fa-solid fa-heart text-4xl text-brand-accent"></i>
            </div>
            <h1 class="text-3xl font-bold text-brand-accent mb-2 tracking-tight">ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³</h1>
            <p class="text-gray-400 text-sm">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨å…±æœ‰ã§ãã‚‹ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ãƒªã‚¹ãƒˆ</p>
        </div>
        
        <button id="login-btn" class="w-full max-w-xs bg-white text-gray-900 font-bold py-4 rounded-xl shadow-lg hover:bg-gray-100 transition-all flex items-center justify-center gap-3">
            <i class="fa-brands fa-google text-xl"></i>
            <span>Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>
        </button>
        <p class="mt-6 text-xs text-gray-600">ã‚¯ãƒ©ã‚¦ãƒ‰ã§åŒæœŸ</p>
    </div>

    <!-- ================= APP HEADER ================= -->
    <header class="sticky top-0 z-40 bg-gray-900/90 backdrop-blur-md border-b border-gray-800 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-heart text-brand-accent text-lg"></i>
            <span class="font-bold text-lg tracking-tight text-gray-100">DatePlans</span>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- Sync Status -->
            <div id="sync-status" class="text-[10px] font-mono text-gray-500 flex items-center gap-1 hidden sm:flex mr-2">
                <span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span>
            </div>
            
            <!-- Connected Users (è‡ªåˆ†ã¨ç›¸æ‰‹ã®ã‚¢ã‚¤ã‚³ãƒ³) -->
            <div id="connected-users" class="flex items-center -space-x-2 mr-2">
                <!-- JSã§å‹•çš„ç”Ÿæˆ -->
            </div>

            <!-- Settings Menu -->
            <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center hover:bg-gray-700 transition-colors">
                <i class="fa-solid fa-gear text-gray-400 text-sm"></i>
            </button>
        </div>
    </header>

    <!-- ================= MAIN CONTENT ================= -->
    <main class="max-w-md mx-auto px-4 pt-6">
        
        <!-- Hero: Today's Pick -->
        <div id="hero-section" class="relative bg-gradient-to-br from-brand-primary to-gray-800 rounded-3xl p-6 shadow-2xl mb-6 overflow-hidden border border-white/5">
            <div class="absolute top-0 right-0 w-32 h-32 bg-brand-accent/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-brand-accent text-brand-dark text-[10px] font-bold px-2 py-1 rounded-md tracking-wider">ä»Šæ—¥ã®ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>
                    <button onclick="pickRandom()" class="text-white/60 hover:text-white transition-colors"><i class="fa-solid fa-shuffle"></i></button>
                </div>
                <div id="todays-pick-content">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="mb-5 relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <i class="fa-solid fa-magnifying-glass text-gray-500 text-sm"></i>
            </div>
            <input type="text" id="search-input" oninput="handleSearch(this.value)" class="w-full bg-gray-800/80 border border-gray-700/50 rounded-2xl pl-10 pr-10 py-3 text-sm text-gray-200 focus:border-brand-accent focus:bg-gray-800 outline-none transition-all shadow-inner" placeholder="ãƒ—ãƒ©ãƒ³åã€ã‚¨ãƒªã‚¢ã€ç‰¹å¾´ã§æ¤œç´¢...">
            <button onclick="clearSearch()" id="search-clear-btn" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-500 hover:text-gray-300 hidden transition-colors">
                <i class="fa-solid fa-circle-xmark"></i>
            </button>
        </div>

        <!-- Filter Tabs -->
        <div class="flex overflow-x-auto gap-2 mb-6 no-scrollbar pb-1" id="category-tabs">
            <!-- Injected by JS -->
        </div>

        <!-- Toolbar (Sort & Count) -->
        <div class="flex justify-between items-center mb-4 px-1">
            <span id="plan-count" class="text-xs font-bold text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
            <div class="flex gap-2">
                <button onclick="toggleSort()" id="sort-btn" class="text-xs font-bold text-gray-400 hover:text-brand-accent transition-colors flex items-center gap-1">
                    <i class="fa-solid fa-arrow-down-short-wide"></i> <span id="sort-label">äºˆç®—</span>
                </button>
            </div>
        </div>

        <!-- Plan List -->
        <div id="plan-list" class="space-y-4 min-h-[50vh]">
            <!-- Injected by JS -->
            <div class="text-center py-20 text-gray-600 animate-pulse">
                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>

    </main>

    <!-- ================= FOOTER NAV ================= -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur-xl border-t border-gray-800 px-4 py-2 flex justify-around items-center z-40 pb-safe max-w-md mx-auto">
        <button onclick="switchTab('all')" id="nav-all" class="flex flex-col items-center gap-1 p-2 text-brand-accent transition-all w-16">
            <i class="fa-solid fa-house text-xl"></i>
            <span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span>
        </button>
        <button onclick="switchTab('favorites')" id="nav-fav" class="flex flex-col items-center gap-1 p-2 text-gray-500 hover:text-gray-300 transition-all w-16">
            <i class="fa-solid fa-heart text-xl"></i>
            <span class="text-[10px] font-bold">ãŠæ°—ã«å…¥ã‚Š</span>
        </button>
        <button onclick="switchTab('done')" id="nav-done" class="flex flex-col items-center gap-1 p-2 text-gray-500 hover:text-gray-300 transition-all w-16">
            <i class="fa-regular fa-circle-check text-xl"></i>
            <span class="text-[10px] font-bold">è¡Œã£ãŸæ¸ˆ</span>
        </button>
    </nav>

    <!-- FAB (Add) -->
    <button onclick="openEditor()" class="fixed bottom-24 right-5 z-40 bg-brand-accent text-brand-dark w-14 h-14 rounded-full shadow-lg shadow-brand-accent/20 flex items-center justify-center text-xl hover:bg-yellow-400 transition-transform active:scale-90">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Bulk Action Panel (ä¸€æ‹¬æ“ä½œ) -->
    <div id="bulk-action-panel" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 border border-gray-700 text-white px-5 py-2.5 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.5)] flex items-center gap-3 z-50 transition-all duration-300 translate-y-24 opacity-0 pointer-events-none">
        <span id="bulk-action-count" class="font-bold text-sm whitespace-nowrap text-brand-accent ml-1">0ä»¶</span>
        <div class="w-px h-5 bg-gray-600 mx-1"></div>
        <button onclick="deleteSelectedPlans()" class="text-red-400 hover:text-red-300 bg-red-900/30 hover:bg-red-900/50 px-3 py-1.5 rounded text-xs font-bold transition-colors whitespace-nowrap flex items-center gap-1.5">
            <i class="fa-solid fa-trash-can"></i> å‰Šé™¤
        </button>
        <button onclick="clearSelection()" class="text-gray-400 hover:text-gray-200 ml-1 p-1"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Editor Modal (Add/Edit) -->
    <div id="editor-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('editor-modal')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-gray-800 rounded-t-3xl p-6 modal-enter max-w-md mx-auto h-[90vh] overflow-y-auto border-t border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 id="editor-title" class="text-xl font-bold text-gray-100">ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ </h2>
                <button onclick="closeModal('editor-modal')" class="w-8 h-8 rounded-full bg-gray-700 text-gray-400 flex items-center justify-center hover:bg-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <form id="plan-form" onsubmit="handleSave(event)" class="space-y-5">
                <input type="hidden" name="id">
                
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">åº—åãƒ»å ´æ‰€å</label>
                    <input type="text" name="name" required class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" placeholder="ä¾‹ï¼šå…­æœ¬æœ¨ãƒ’ãƒ«ã‚º">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">ã‚«ãƒ†ã‚´ãƒª</label>
                        <select name="category" id="plan-category-select" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none appearance-none">
                            <!-- JSã§å‹•çš„ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">äºˆç®— (2äººåˆ†)</label>
                        <input type="number" name="budget" required class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none" placeholder="10000">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">ä½•ã‚’ã™ã‚‹ï¼Ÿ</label>
                    <input type="text" name="activity" required class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none" placeholder="ä¾‹ï¼šå¤œæ™¯ã‚’è¦‹ãªãŒã‚‰ãƒ‡ã‚£ãƒŠãƒ¼">
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">ãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆ</label>
                    <textarea name="why" rows="2" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none" placeholder="ä¾‹ï¼šé›°å›²æ°—ãŒè‰¯ãã¦è¨˜å¿µæ—¥ã«ã´ã£ãŸã‚Š"></textarea>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">ãƒ¡ãƒ¢</label>
                    <textarea name="memo" id="input-memo" rows="2" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none" placeholder="ä¾‹ï¼šäºˆç´„ã¯æ—©ã‚ãŒãŠã™ã™ã‚"></textarea>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">é–¢é€£ãƒªãƒ³ã‚¯ (æ”¹è¡Œã§è¤‡æ•°URL)</label>
                    <textarea name="links" id="input-links" rows="2" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none font-mono text-xs" placeholder="https://..."></textarea>
                </div>

                <div class="flex items-center gap-3 p-4 bg-gray-900 rounded-xl border border-gray-700">
                    <input type="checkbox" name="isChoco" id="chk-choco" class="w-5 h-5 accent-brand-accent rounded">
                    <label for="chk-choco" class="text-sm font-bold text-brand-primary cursor-pointer flex items-center gap-2">
                        <i class="fa-solid fa-mug-hot"></i> ãƒãƒ§ã‚³ãƒ»ã‚¹ã‚¤ãƒ¼ãƒ„é–¢é€£
                    </label>
                </div>

                <button type="submit" class="w-full bg-brand-accent text-brand-dark font-bold py-4 rounded-xl shadow-lg mt-4 active:scale-95 transition-transform">
                    <i class="fa-solid fa-save mr-2"></i> ä¿å­˜ã™ã‚‹
                </button>
            </form>
        </div>
    </div>

    <!-- Settings Modal (Sync & Import) -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('settings-modal')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-gray-800 rounded-t-3xl p-6 modal-enter max-w-md mx-auto h-[90vh] overflow-y-auto border-t border-gray-700 pb-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-100">è¨­å®š</h2>
                <button onclick="closeModal('settings-modal')" class="w-8 h-8 rounded-full bg-gray-700 text-gray-400 flex items-center justify-center hover:bg-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <!-- Profile Info (Readonly) -->
            <div class="flex items-center gap-3 mb-6 p-4 bg-gray-900 rounded-xl border border-gray-700">
                <img id="settings-avatar" src="" class="w-12 h-12 rounded-full object-cover border border-gray-600">
                <div>
                    <p id="settings-name" class="font-bold text-sm text-gray-200">Name</p>
                    <p class="text-[10px] text-gray-500 font-mono">ID: <span id="settings-uid"></span></p>
                </div>
            </div>

            <!-- Category Management -->
            <div class="mb-8">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</label>
                <div class="p-4 bg-gray-900 rounded-xl border border-gray-700">
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-category-input" class="flex-1 bg-black border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-600 outline-none focus:border-brand-accent" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå">
                        <button onclick="addCategory()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-xs font-bold text-white transition-colors">è¿½åŠ </button>
                    </div>
                    <div id="category-list-settings" class="flex flex-wrap gap-2">
                        <!-- JSã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- Shared ID Config -->
            <div class="mb-8">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨åŒæœŸ</label>
                <div class="p-4 bg-gray-900 rounded-xl border border-gray-700">
                    <p class="text-xs text-gray-400 mb-2">ã‚ãªãŸã®ID (ã“ã‚Œã‚’ç›¸æ‰‹ã«ä¼ãˆã¦ãã ã•ã„):</p>
                    <div class="flex items-center gap-2 mb-4">
                        <code id="my-uid-display" class="flex-1 bg-black p-2 rounded text-xs font-mono text-brand-accent truncate select-all">...</code>
                        <button onclick="copyUid()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-copy"></i></button>
                    </div>

                    <p class="text-xs text-gray-400 mb-2">ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦åŒæœŸ:</p>
                    <div class="flex gap-2">
                        <input type="text" id="target-uid-input" class="flex-1 bg-black border border-gray-700 rounded-lg px-3 py-2 text-sm text-white font-mono placeholder-gray-600 outline-none focus:border-brand-accent" placeholder="Partner's UID">
                        <button onclick="setTargetUid()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-xs font-bold text-white transition-colors">æ¥ç¶š</button>
                    </div>
                    <p id="connection-status" class="text-[10px] text-brand-accent mt-2 hidden"><i class="fa-solid fa-link"></i> ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã«æ¥ç¶šä¸­</p>
                </div>
            </div>

            <!-- Import/Export Data -->
            <div class="mb-8">
                 <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">ãƒ‡ãƒ¼ã‚¿ã®å…¥å‡ºåŠ› (JSON)</label>
                 <p class="text-[10px] text-gray-400 mb-2">AIã§ç”Ÿæˆã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦è¿½åŠ ã§ãã¾ã™ã€‚</p>
                 <textarea id="import-json-input" rows="3" class="w-full bg-black border border-gray-700 rounded-lg px-3 py-2 text-xs text-white font-mono placeholder-gray-600 outline-none focus:border-brand-accent mb-2" placeholder='[{"name": "...", "category": "å¤œã”ã¯ã‚“", "budget": 10000}]'></textarea>
                 <div class="flex gap-2">
                     <button onclick="importJsonData()" class="flex-1 bg-gray-700 text-gray-300 py-3 rounded-xl hover:bg-gray-600 text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                        <i class="fa-solid fa-file-import"></i> ç™»éŒ²ã™ã‚‹
                     </button>
                     <button onclick="exportAllPlans()" class="flex-1 bg-gray-700 text-gray-300 py-3 rounded-xl hover:bg-gray-600 text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                        <i class="fa-solid fa-file-export"></i> å…¨ã¦ã‚³ãƒ”ãƒ¼
                     </button>
                 </div>
            </div>

            <!-- Danger Zone -->
            <div class="mb-8 p-4 bg-red-900/10 rounded-xl border border-red-900/30">
                 <label class="text-xs font-bold text-red-500 uppercase tracking-wider mb-2 block"><i class="fa-solid fa-triangle-exclamation"></i> å±é™ºãªæ“ä½œ</label>
                 <button onclick="deleteAllData()" class="w-full bg-red-900/40 text-red-400 py-3 rounded-xl hover:bg-red-900/60 text-sm font-bold flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-trash-can"></i> å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã™ã‚‹
                 </button>
            </div>

            <button onclick="handleLogout()" class="w-full border border-gray-700 text-gray-400 py-3 rounded-xl hover:bg-gray-800 text-sm font-bold mt-4 transition-colors">
                <i class="fa-solid fa-right-from-bracket mr-2"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>
    </div>

    <!-- ================= JAVASCRIPT ================= -->
    <script type="module">
        // --- FIREBASE CONFIGURATION (ã“ã“ã«è‡ªåˆ†ã®è¨­å®šã‚’è²¼ã‚Šä»˜ã‘) ---
        const firebaseConfig = {
  apiKey: "AIzaSyCh6ml98fmFPvPptdYQcPnOLc06kK7uVCQ",
  authDomain: "dateplan-38034.firebaseapp.com",
  projectId: "dateplan-38034",
  storageBucket: "dateplan-38034.firebasestorage.app",
  messagingSenderId: "243893644952",
  appId: "1:243893644952:web:2a0953206d782a9965eaed"
};
        // --------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Global State
        window.state = {
            user: null,
            targetUid: null,
            data: { plans: [], categories: [], users: {} }, // usersæƒ…å ±ã‚’è¿½åŠ 
            filter: 'ã™ã¹ã¦',
            sortBy: 'budget', // 'budget' | 'budget-desc'
            viewMode: 'all',  // 'all' | 'favorites' | 'done'
            searchQuery: '',  // æ¤œç´¢ã‚¯ã‚¨ãƒª
            unsubscribe: null,
            selectedPlans: new Set()
        };

        const DEFAULT_CATEGORIES = ['å¤œã”ã¯ã‚“', 'ä¼‘æ—¥æ˜¼', 'é å‡º', 'ãŠå®¶', 'å­£ç¯€é™å®š', 'ãŠæ³Šã¾ã‚Š'];

        // --- Firebase Init ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error (Check Config):", e);
            alert("Firebaseè¨­å®šãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚HTMLã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å†…ã®firebaseConfigã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚");
        }

        // --- Auth Logic ---
        const provider = new GoogleAuthProvider();
        const loginBtn = document.getElementById('login-btn');
        const authOverlay = document.getElementById('auth-overlay');

        // â˜… ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¤‰æ›´ï¼ˆLINEå†…ãƒ–ãƒ©ã‚¦ã‚¶å¯¾ç­–ï¼‰
        loginBtn.addEventListener('click', async () => {
            try {
                loginBtn.innerHTML = '<div class="loader"></div>';
                await signInWithRedirect(auth, provider);
            } catch (error) {
                console.error(error);
                alert(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                loginBtn.innerHTML = '<i class="fa-brands fa-google text-xl"></i><span>Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>';
            }
        });

        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‹ã‚‰æˆ»ã£ã¦ããŸã¨ãã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        getRedirectResult(auth).catch((error) => {
            console.error("Redirect Auth Error:", error);
            let errorMessage = `ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            if (error.code === 'auth/unauthorized-domain') {
                errorMessage = "ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘\nã“ã®ã‚µã‚¤ãƒˆã®URLãŒFirebaseã®ã€Œæ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nFirebase Consoleã§è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            }
            alert(errorMessage);
            loginBtn.innerHTML = '<i class="fa-brands fa-google text-xl"></i><span>Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>';
        });

        window.handleLogout = async () => {
            if (window.state.unsubscribe) window.state.unsubscribe(); 
            await signOut(auth);
            closeModal('settings-modal');
        };

        onAuthStateChanged(auth, (user) => {
            window.state.user = user;
            if (user) {
                // Logged In
                authOverlay.classList.add('opacity-0', 'pointer-events-none');
                
                // è¨­å®šç”»é¢ç”¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                document.getElementById('settings-avatar').src = user.photoURL;
                document.getElementById('settings-name').textContent = user.displayName;
                document.getElementById('settings-uid').textContent = user.uid;
                
                document.getElementById('my-uid-display').textContent = user.uid;
                
                const savedTarget = localStorage.getItem('smartDate_targetUid');
                window.state.targetUid = savedTarget || user.uid;
                
                if (savedTarget && savedTarget !== user.uid) {
                    document.getElementById('target-uid-input').value = savedTarget;
                    document.getElementById('connection-status').classList.remove('hidden');
                }

                initFirestoreSync();
            } else {
                // Logged Out
                authOverlay.classList.remove('opacity-0', 'pointer-events-none');
                window.state.data = { plans: [], categories: [], users: {} };
                render();
            }
        });

        // --- Firestore Logic ---
        function initFirestoreSync() {
            if (!window.state.user) return;
            
            updateSyncStatus('åŒæœŸä¸­...', 'yellow');
            
            if (window.state.unsubscribe) window.state.unsubscribe();

            const docRef = doc(db, "users", window.state.targetUid, "appData", "v1");

            window.state.unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    window.state.data = cloudData.json ? JSON.parse(cloudData.json) : { plans: [], categories: [], users: {} };
                    
                    if (!window.state.data.categories || window.state.data.categories.length === 0) {
                        window.state.data.categories = [...DEFAULT_CATEGORIES];
                    }
                    if (!window.state.data.users) window.state.data.users = {};

                    updateSyncStatus('åŒæœŸå®Œäº†', 'green');
                } else {
                    // No data yet
                    window.state.data = { plans: [], categories: [...DEFAULT_CATEGORIES], users: {} };
                    updateSyncStatus('ãƒ‡ãƒ¼ã‚¿ãªã—', 'gray');
                }
                
                // IDãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const existingIds = new Set(window.state.data.plans.map(p => p.id));
                window.state.selectedPlans = new Set([...window.state.selectedPlans].filter(id => existingIds.has(id)));
                
                updateBulkActionPanel();
                render();
            }, (error) => {
                console.error("Firestore Error:", error);
                if (error.code === 'permission-denied') {
                     alert("ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                     updateSyncStatus('ã‚¨ãƒ©ãƒ¼', 'red');
                }
            });
        }

        async function saveDataToCloud() {
            if (!window.state.user) return;
            updateSyncStatus('ä¿å­˜ä¸­...', 'yellow');
            
            try {
                // â˜… è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ã«ãƒãƒ¼ã‚¸ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰
                if (!window.state.data.users) window.state.data.users = {};
                window.state.data.users[window.state.user.uid] = {
                    photoURL: window.state.user.photoURL,
                    displayName: window.state.user.displayName || "User"
                };

                const docRef = doc(db, "users", window.state.targetUid, "appData", "v1");
                const payload = {
                    json: JSON.stringify(window.state.data),
                    updatedAt: new Date(),
                    updatedBy: window.state.user.uid
                };
                await setDoc(docRef, payload);
            } catch (error) {
                console.error("Save Error:", error);
                alert(`ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateSyncStatus('ã‚¨ãƒ©ãƒ¼', 'red');
            }
        }

        // --- App Logic ---

        // æ¤œç´¢ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.handleSearch = (val) => {
            window.state.searchQuery = val.trim().toLowerCase();
            document.getElementById('search-clear-btn').classList.toggle('hidden', window.state.searchQuery === '');
            renderList();
        };

        window.clearSearch = () => {
            document.getElementById('search-input').value = '';
            window.handleSearch('');
        };

        // ã‚·ã‚§ã‚¢æ©Ÿèƒ½
        window.sharePlan = async (id) => {
            const plan = window.state.data.plans.find(p => p.id === id);
            if (!plan) return;

            // ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã®çµ„ã¿ç«‹ã¦
            let text = `ã“ã“ã©ã†ï¼ŸğŸ¥‚\nã€${plan.name}ã€‘\nğŸ’° äºˆç®—: ç´„Â¥${plan.budget.toLocaleString()}\n\nğŸ’¬ ${plan.activity}\n${plan.why}\n`;
            if (plan.links && plan.links.length > 0) {
                text += `\nğŸ”— ${plan.links[0]}`;
            }

            // Web Share API ãŒä½¿ãˆã‚‹ã‚¹ãƒãƒ›ç­‰ã®å ´åˆ
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ã®ææ¡ˆ',
                        text: text
                    });
                } catch (err) {
                    console.log('Share canceled', err);
                }
            } else {
                // ä½¿ãˆãªã„PCãƒ–ãƒ©ã‚¦ã‚¶ç­‰ã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                try {
                    await navigator.clipboard.writeText(text);
                    alert("ãƒ—ãƒ©ãƒ³ã®è©³ç´°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nLINEç­‰ã«è²¼ã‚Šä»˜ã‘ã¦ç›¸æ‰‹ã«é€ä¿¡ã§ãã¾ã™ã€‚");
                } catch (err) {
                    alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            }
        };

        window.importJsonData = async () => {
            const inputEl = document.getElementById('import-json-input');
            const jsonStr = inputEl.value.trim();
            if (!jsonStr) {
                alert("JSONãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
                return;
            }

            try {
                const newPlans = JSON.parse(jsonStr);
                if (!Array.isArray(newPlans)) {
                    throw new Error("ãƒ‡ãƒ¼ã‚¿ã¯é…åˆ—ï¼ˆ[ ]ï¼‰ã§å›²ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
                }

                if(confirm(`${newPlans.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã‹ï¼Ÿ(æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã•ã‚Œã¾ã™)`)) {
                    let importedCount = 0;
                    const newValidPlans = [];

                    for (const p of newPlans) {
                        if (!p.name) continue; 
                        
                        const isNameDuplicate = window.state.data.plans.some(existing => existing.name === p.name);
                        if (isNameDuplicate) continue; 

                        p.id = Date.now() + Math.floor(Math.random() * 100000) + importedCount;
                        if (!p.links) p.links = [];
                        if (typeof p.isChoco === 'undefined') p.isChoco = false;
                        if (typeof p.done === 'undefined') p.done = false;
                        if (!p.likes) p.likes = [];
                        if (!p.memo) p.memo = "";

                        newValidPlans.push(p);
                        importedCount++;
                    }

                    if (importedCount === 0) {
                        alert("å–ã‚Šè¾¼ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n(â€»ã™ã§ã«åŒã˜åå‰ã®ãƒ—ãƒ©ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™)");
                        return;
                    }

                    window.state.data.plans = [...window.state.data.plans, ...newValidPlans];
                    
                    newValidPlans.forEach(p => {
                        if (p.category && !window.state.data.categories.includes(p.category)) {
                            window.state.data.categories.push(p.category);
                        }
                    });

                    await saveDataToCloud();
                    inputEl.value = ''; 
                    closeModal('settings-modal');
                    alert(`${importedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼`);
                }
            } catch (e) {
                alert(`JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\nã‚¨ãƒ©ãƒ¼è©³ç´°: ${e.message}`);
            }
        };

        window.handleSave = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const linksText = formData.get('links');
            const linksArray = linksText ? linksText.split('\n').map(l => l.trim()).filter(l => l !== '') : [];

            const newPlan = {
                id: formData.get('id') ? parseInt(formData.get('id')) : Date.now(),
                name: formData.get('name'),
                category: formData.get('category'),
                budget: parseInt(formData.get('budget')),
                activity: formData.get('activity'),
                why: formData.get('why'),
                memo: formData.get('memo'),
                links: linksArray,
                isChoco: form.querySelector('[name=isChoco]').checked,
                done: false,
                likes: []
            };

            const existingIdx = window.state.data.plans.findIndex(p => p.id === newPlan.id);
            if (existingIdx >= 0) {
                newPlan.likes = window.state.data.plans[existingIdx].likes;
                newPlan.done = window.state.data.plans[existingIdx].done;
                window.state.data.plans[existingIdx] = newPlan;
            } else {
                window.state.data.plans.unshift(newPlan);
            }

            await saveDataToCloud();
            closeModal('editor-modal');
        };

        window.toggleLike = async (id) => {
            const plan = window.state.data.plans.find(p => p.id === id);
            const uid = window.state.user.uid;
            if (!plan.likes) plan.likes = [];
            
            if (plan.likes.includes(uid)) {
                plan.likes = plan.likes.filter(u => u !== uid);
            } else {
                plan.likes.push(uid);
            }
            await saveDataToCloud(); 
        };

        window.toggleDone = async (id) => {
            const plan = window.state.data.plans.find(p => p.id === id);
            plan.done = !plan.done;
            await saveDataToCloud();
        };

        window.deletePlan = async (id) => {
            if(confirm('ã“ã®ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                window.state.data.plans = window.state.data.plans.filter(p => p.id !== id);
                if(window.state.selectedPlans.has(id)) {
                    window.state.selectedPlans.delete(id);
                    updateBulkActionPanel();
                }
                await saveDataToCloud();
            }
        };

        window.toggleSelection = (id) => {
            if(window.state.selectedPlans.has(id)) {
                window.state.selectedPlans.delete(id);
            } else {
                window.state.selectedPlans.add(id);
            }
            updateBulkActionPanel();
            renderList(); 
        };

        window.clearSelection = () => {
            window.state.selectedPlans.clear();
            updateBulkActionPanel();
            renderList();
        };

        window.deleteSelectedPlans = async () => {
            if(confirm(`${window.state.selectedPlans.size}ä»¶ã®ãƒ—ãƒ©ãƒ³ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                window.state.data.plans = window.state.data.plans.filter(p => !window.state.selectedPlans.has(p.id));
                window.state.selectedPlans.clear();
                updateBulkActionPanel();
                await saveDataToCloud();
            }
        };

        window.exportAllPlans = () => {
            const allData = window.state.data.plans;
            if (allData.length === 0) {
                alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }
            
            const jsonStr = JSON.stringify(allData, null, 2);

            const textArea = document.createElement("textarea");
            textArea.value = jsonStr;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert(`å…¨${allData.length}ä»¶ã®ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`);
                    closeModal('settings-modal');
                } else {
                    alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            }

            document.body.removeChild(textArea);
        };

        function updateBulkActionPanel() {
            const panel = document.getElementById('bulk-action-panel');
            const count = document.getElementById('bulk-action-count');
            if(window.state.selectedPlans.size > 0) {
                count.innerText = `${window.state.selectedPlans.size}ä»¶`;
                panel.classList.remove('translate-y-24', 'opacity-0', 'pointer-events-none');
            } else {
                panel.classList.add('translate-y-24', 'opacity-0', 'pointer-events-none');
            }
        }

        window.addCategory = async () => {
            const input = document.getElementById('new-category-input');
            const val = input.value.trim();
            if(val && !window.state.data.categories.includes(val)) {
                window.state.data.categories.push(val);
                input.value = '';
                await saveDataToCloud();
            }
        };

        window.removeCategory = async (cat) => {
            if(confirm(`ã‚«ãƒ†ã‚´ãƒªã€Œ${cat}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n(â€»ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ©ãƒ³ã®ã‚«ãƒ†ã‚´ãƒªã¯ãã®ã¾ã¾æ®‹ã‚Šã¾ã™)`)){
                window.state.data.categories = window.state.data.categories.filter(c => c !== cat);
                if(window.state.filter === cat) {
                    window.state.filter = 'ã™ã¹ã¦';
                }
                await saveDataToCloud();
            }
        };

        window.deleteAllData = async () => {
            if(confirm("ã€è­¦å‘Šã€‘ã™ã¹ã¦ã®ãƒ—ãƒ©ãƒ³ã¨è¿½åŠ ã—ãŸã‚«ãƒ†ã‚´ãƒªãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nå…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                if(prompt("ç¢ºèªã®ãŸã‚ã€ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚") === "å‰Šé™¤") {
                    window.state.data.plans = [];
                    window.state.data.categories = [...DEFAULT_CATEGORIES];
                    window.state.selectedPlans.clear();
                    window.state.filter = 'ã™ã¹ã¦';
                    updateBulkActionPanel();
                    await saveDataToCloud();
                    closeModal('settings-modal');
                    alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã—ãŸã€‚");
                } else {
                    alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚");
                }
            }
        };

        window.copyUid = () => {
            const uid = document.getElementById('my-uid-display').innerText;
            navigator.clipboard.writeText(uid);
            alert('IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        };

        window.setTargetUid = () => {
            const input = document.getElementById('target-uid-input').value.trim();
            if (input) {
                window.state.targetUid = input;
                localStorage.setItem('smartDate_targetUid', input);
                alert('æ¥ç¶šå…ˆã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚å†åŒæœŸã—ã¾ã™ã€‚');
                initFirestoreSync();
                closeModal('settings-modal');
            }
        };

        // --- UI Rendering ---

        function render() {
            renderHeaderUsers();
            renderTabs();
            renderList();
            renderCategorySettings();
            renderCategorySelect();
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ç¹‹ãŒã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
        function renderHeaderUsers() {
            const container = document.getElementById('connected-users');
            if (!window.state.data.users) {
                container.innerHTML = '';
                return;
            }
            
            const uids = Object.keys(window.state.data.users);
            container.innerHTML = uids.map(uid => {
                const u = window.state.data.users[uid];
                if (!u || !u.photoURL) return '';
                const isMe = window.state.user && uid === window.state.user.uid;
                const borderClass = isMe ? 'border-brand-accent z-10' : 'border-gray-600 opacity-90';
                return `<img src="${u.photoURL}" class="w-7 h-7 rounded-full border-2 ${borderClass} object-cover relative shadow-sm" title="${u.displayName}">`;
            }).join('');
        }

        function renderTabs() {
            const container = document.getElementById('category-tabs');
            const cats = ['ã™ã¹ã¦', ...(window.state.data.categories || [])];
            
            container.innerHTML = cats.map(cat => `
                <button onclick="setFilter('${cat}')" 
                    class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition-all border ${window.state.filter === cat ? 'bg-brand-primary text-brand-accent border-brand-accent' : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700/50'}">
                    ${cat}
                </button>
            `).join('');
        }

        function renderCategorySettings() {
            const listEl = document.getElementById('category-list-settings');
            const cats = window.state.data.categories || [];
            listEl.innerHTML = cats.map(cat => `
                <span class="bg-gray-700 text-gray-200 px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-2 border border-gray-600">
                    ${cat} 
                    <button onclick="removeCategory('${cat}')" class="text-gray-400 hover:text-red-400 p-0.5"><i class="fa-solid fa-xmark"></i></button>
                </span>
            `).join('');
        }

        function renderCategorySelect() {
            const selectEl = document.getElementById('plan-category-select');
            const cats = window.state.data.categories || [];
            selectEl.innerHTML = cats.map(cat => `
                <option value="${cat}">${cat}</option>
            `).join('');
        }

        function renderList() {
            let list = [...window.state.data.plans];
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
            if (window.state.filter !== 'ã™ã¹ã¦') {
                list = list.filter(p => p.category === window.state.filter);
            }
            // ã‚¿ãƒ–ãƒ•ã‚£ãƒ«ã‚¿
            if (window.state.viewMode === 'favorites') {
                list = list.filter(p => p.likes && p.likes.includes(window.state.user.uid));
            } else if (window.state.viewMode === 'done') {
                list = list.filter(p => p.done);
            }
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
            if (window.state.searchQuery) {
                const q = window.state.searchQuery;
                list = list.filter(p => 
                    p.name.toLowerCase().includes(q) || 
                    p.activity.toLowerCase().includes(q) || 
                    (p.why && p.why.toLowerCase().includes(q)) || 
                    (p.memo && p.memo.toLowerCase().includes(q))
                );
            }

            // ã‚½ãƒ¼ãƒˆ
            if (window.state.sortBy === 'budget') list.sort((a,b) => a.budget - b.budget);
            if (window.state.sortBy === 'budget-desc') list.sort((a,b) => b.budget - a.budget);

            let countLabel = 'ä»¶ã®ãƒ—ãƒ©ãƒ³';
            if (window.state.viewMode === 'favorites') countLabel = 'ä»¶ã®ãŠæ°—ã«å…¥ã‚Š';
            if (window.state.viewMode === 'done') countLabel = 'ä»¶ã®è¡Œã£ãŸæ¸ˆãƒ—ãƒ©ãƒ³';
            if (window.state.searchQuery) countLabel = 'ä»¶ã®æ¤œç´¢çµæœ';
            document.getElementById('plan-count').textContent = `${list.length} ${countLabel}`;

            const container = document.getElementById('plan-list');
            
            if (list.length === 0) {
                if (window.state.searchQuery) {
                    container.innerHTML = `<div class="text-center py-10 text-gray-600"><p>ä¸€è‡´ã™ã‚‹ãƒ—ãƒ©ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p></div>`;
                } else if (window.state.viewMode === 'favorites') {
                    container.innerHTML = `
                        <div class="text-center py-20 text-gray-600">
                            <i class="fa-solid fa-heart w-12 h-12 mx-auto mb-3 opacity-20 text-4xl block"></i>
                            <p class="text-sm">ã¾ã ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ°—ã«ãªã‚‹ãƒ—ãƒ©ãƒ³ã«â™¡ã‚’æŠ¼ã—ã¦ã¿ã¦ã­ï¼</p>
                        </div>`;
                } else if (window.state.viewMode === 'done') {
                    container.innerHTML = `
                        <div class="text-center py-20 text-gray-600">
                            <i class="fa-regular fa-circle-check w-12 h-12 mx-auto mb-3 opacity-20 text-4xl block"></i>
                            <p class="text-sm">ã¾ã ã€Œè¡Œã£ãŸæ¸ˆã€ã®ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ãƒ‡ãƒ¼ãƒˆã«è¡Œã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                        </div>`;
                } else {
                    container.innerHTML = `<div class="text-center py-10 text-gray-600"><p>ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>`;
                }
                return;
            }

            container.innerHTML = list.map(plan => {
                const isLiked = plan.likes && window.state.user && plan.likes.includes(window.state.user.uid);
                const isDone = plan.done;
                const isSelected = window.state.selectedPlans.has(plan.id);
                
                // ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã®æç”»
                const linkList = plan.links && plan.links.length > 0 
                    ? `<div class="mt-3 flex flex-wrap gap-2">
                        ${plan.links.map(url => `
                            <a href="${url}" target="_blank" onclick="event.stopPropagation();" class="inline-flex items-center gap-1 bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1.5 rounded-lg text-[10px] transition-colors border border-gray-600">
                                <i class="fa-solid fa-link text-[10px]"></i> ãƒªãƒ³ã‚¯ã‚’é–‹ã
                            </a>
                        `).join('')}
                       </div>`
                    : '';

                // â˜… ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ç¾¤ã‚’ç”Ÿæˆ
                const likedUsersHtml = plan.likes && plan.likes.length > 0 ? 
                    `<div class="flex -space-x-1.5 mr-2">
                        ${plan.likes.map(uid => {
                            const u = window.state.data.users && window.state.data.users[uid];
                            if (!u || !u.photoURL) return '';
                            return `<img src="${u.photoURL}" class="w-5 h-5 rounded-full border border-gray-800 object-cover" title="${u.displayName}">`;
                        }).join('')}
                    </div>` : '';

                return `
                <div onclick="toggleSelection(${plan.id})" class="fade-in bg-gray-800 rounded-2xl overflow-hidden border ${isDone ? 'border-green-800 opacity-80' : 'border-gray-700'} relative group cursor-pointer transition-all ${isSelected ? 'ring-2 ring-red-500 bg-gray-700' : 'hover:bg-gray-700/50'} shadow-lg">
                    <!-- Image/Color Banner -->
                    <div class="h-24 ${plan.isChoco ? 'bg-[#3E2723]' : 'bg-gray-700'} relative overflow-hidden pointer-events-none">
                        ${plan.isChoco ? '<div class="absolute inset-0 opacity-20 bg-[url(\'https://www.transparenttextures.com/patterns/cubes.png\')]"></div>' : ''}
                        
                        <div class="absolute top-2 left-2 z-10 pointer-events-auto flex gap-2 items-center">
                            <input type="checkbox" class="w-5 h-5 accent-red-500 rounded cursor-pointer" 
                                   ${isSelected ? 'checked' : ''} 
                                   onclick="event.stopPropagation(); toggleSelection(${plan.id})">
                        </div>

                        <div class="absolute bottom-2 left-3 flex gap-2">
                             <span class="text-[10px] font-bold bg-gray-900/80 text-gray-300 px-2 py-1 rounded backdrop-blur-sm shadow-sm">${plan.category}</span>
                             ${plan.isChoco ? '<span class="text-[10px] font-bold bg-brand-accent text-brand-dark px-2 py-1 rounded shadow-sm"><i class="fa-solid fa-mug-hot"></i> ãƒãƒ§ã‚³</span>' : ''}
                        </div>

                        <div class="absolute right-2 top-2 flex gap-1.5 pointer-events-auto">
                             <button onclick="event.stopPropagation(); openEditor(${plan.id})" class="w-8 h-8 rounded-full bg-black/50 text-white hover:bg-brand-accent hover:text-brand-dark flex items-center justify-center transition-colors backdrop-blur"><i class="fa-solid fa-pencil text-xs"></i></button>
                             <button onclick="event.stopPropagation(); deletePlan(${plan.id})" class="w-8 h-8 rounded-full bg-black/50 text-white hover:bg-red-500 flex items-center justify-center transition-colors backdrop-blur"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>

                        ${isDone ? '<div class="absolute inset-0 bg-black/60 flex items-center justify-center backdrop-blur-sm"><span class="text-green-400 font-bold border-2 border-green-400 px-3 py-1 rounded transform -rotate-12 text-sm shadow-[0_0_15px_rgba(74,222,128,0.3)]">è¡Œã£ãŸæ¸ˆ</span></div>' : ''}
                    </div>

                    <div class="p-4">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-bold text-lg text-gray-100 leading-tight">${plan.name}</h3>
                        </div>
                        
                        <div class="flex items-center gap-4 text-xs text-gray-400 mb-3">
                            <span><i class="fa-solid fa-person-snowboarding text-brand-accent mr-1"></i> ${plan.activity}</span>
                            <span><i class="fa-solid fa-wallet text-brand-accent mr-1"></i> Â¥${plan.budget.toLocaleString()}</span>
                        </div>

                        <div class="bg-gray-900/50 p-3 rounded-xl border border-gray-700/50 mb-3">
                            <p class="text-xs text-gray-300 leading-relaxed"><i class="fa-solid fa-quote-left text-gray-600 mr-1.5"></i>${plan.why}</p>
                            ${plan.memo ? `<div class="mt-2 pt-2 border-t border-gray-700/50 text-[10px] text-gray-500 font-mono"><span class="font-bold text-gray-400 block mb-1">MEMO</span>${plan.memo.replace(/\n/g, '<br>')}</div>` : ''}
                            ${linkList}
                        </div>

                        <div class="flex items-center justify-between mt-2 pt-1">
                            <button onclick="event.stopPropagation(); toggleDone(${plan.id})" class="text-xs font-bold ${isDone ? 'text-green-500 bg-green-900/20' : 'text-gray-500 bg-gray-700/30 hover:bg-gray-700/80 hover:text-gray-300'} flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-colors border border-transparent ${isDone ? 'border-green-900/50' : ''}">
                                <i class="fa-regular fa-circle-check"></i> ${isDone ? 'è¡Œã£ãŸæ¸ˆ' : 'è¡Œã£ãŸï¼'}
                            </button>

                            <div class="flex items-center">
                                <!-- ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
                                <button onclick="event.stopPropagation(); sharePlan(${plan.id})" class="text-gray-500 hover:text-gray-300 transition-colors p-2 mr-2">
                                    <i class="fa-solid fa-arrow-up-from-bracket"></i>
                                </button>
                                
                                <!-- ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ç¾¤ -->
                                ${likedUsersHtml}
                                
                                <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
                                <button onclick="event.stopPropagation(); toggleLike(${plan.id})" class="text-xl transition-transform active:scale-125 ${isLiked ? 'text-red-500 icon-pop' : 'text-gray-600 hover:text-gray-400'} p-1">
                                    <i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- Helpers ---
        window.setFilter = (cat) => { window.state.filter = cat; render(); };
        window.switchTab = (mode) => { 
            window.state.viewMode = mode; 
            const baseClass = 'flex flex-col items-center gap-1 p-2 transition-all w-16';
            document.getElementById('nav-all').className = mode === 'all' ? `${baseClass} text-brand-accent` : `${baseClass} text-gray-500 hover:text-gray-300`;
            document.getElementById('nav-fav').className = mode === 'favorites' ? `${baseClass} text-brand-accent` : `${baseClass} text-gray-500 hover:text-gray-300`;
            document.getElementById('nav-done').className = mode === 'done' ? `${baseClass} text-brand-accent` : `${baseClass} text-gray-500 hover:text-gray-300`;
            render(); 
        };
        window.toggleSort = () => { 
            window.state.sortBy = window.state.sortBy === 'budget' ? 'budget-desc' : 'budget';
            document.getElementById('sort-label').textContent = window.state.sortBy === 'budget' ? 'å®‰ã„é †' : 'é«˜ã„é †';
            render();
        };

        window.openEditor = (id = null) => {
            const form = document.getElementById('plan-form');
            form.reset();
            document.getElementById('editor-title').textContent = id ? 'ãƒ—ãƒ©ãƒ³ã‚’ç·¨é›†' : 'ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ ';
            
            if (id) {
                const plan = window.state.data.plans.find(p => p.id === id);
                if (plan) {
                    form.querySelector('[name=id]').value = plan.id;
                    form.querySelector('[name=name]').value = plan.name;
                    form.querySelector('[name=category]').value = plan.category;
                    form.querySelector('[name=budget]').value = plan.budget;
                    form.querySelector('[name=activity]').value = plan.activity;
                    form.querySelector('[name=why]').value = plan.why;
                    
                    document.getElementById('input-memo').value = plan.memo || '';
                    document.getElementById('input-links').value = (plan.links || []).join('\n');
                    
                    form.querySelector('[name=isChoco]').checked = plan.isChoco;
                }
            } else {
                form.querySelector('[name=id]').value = '';
            }
            document.getElementById('editor-modal').classList.remove('hidden');
        };

        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.pickRandom = () => {
            const list = window.state.data.plans;
            if (list.length === 0) return;
            const r = list[Math.floor(Math.random() * list.length)];
            const el = document.getElementById('todays-pick-content');
            el.innerHTML = `
                <h3 class="font-bold text-white text-lg">${r.name}</h3>
                <p class="text-xs text-gray-300 mb-1">${r.activity}</p>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] bg-black/30 px-2 py-1 rounded text-brand-accent">Â¥${r.budget.toLocaleString()}</span>
                </div>
            `;
        };

        function updateSyncStatus(msg, color) {
            const el = document.getElementById('sync-status');
            el.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-${color}-500"></span>`;
            el.title = msg;
        }

    </script>
</body>
</html>
