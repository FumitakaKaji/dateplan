<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartDatePlans - Couple Shared App</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    
    <!-- Icons: FontAwesome (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles: Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#1a1614',    /* Deep Chocolate/Black */
                            primary: '#5D4037', /* Chocolate */
                            accent: '#D4AF37',  /* Gold */
                            light: '#EFEBE9',   /* Beige */
                            surface: '#2c2420'  /* Card Surface */
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #111827; /* gray-900 */
            color: #E5E7EB; /* gray-200 */
            -webkit-font-smoothing: antialiased;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes pop { 50% { transform: scale(1.2); } }
        .icon-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .modal-enter { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Loader */
        .loader { border: 2px solid #374151; border-top: 2px solid #D4AF37; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 pb-24 min-h-screen relative overflow-x-hidden selection:bg-brand-accent selection:text-brand-dark">

    <!-- ================= AUTH OVERLAY ================= -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="text-center mb-10">
            <div class="inline-block p-4 rounded-full bg-brand-primary/20 mb-4 border border-brand-accent/30">
                <i class="fa-solid fa-heart text-4xl text-brand-accent"></i>
            </div>
            <h1 class="text-4xl font-serif font-bold text-brand-accent mb-2 tracking-tight">Smart Date Plans</h1>
            <p class="text-gray-400 text-sm">二人のための特別なデートプラン管理</p>
        </div>
        
        <button id="login-btn" class="w-full max-w-xs bg-white text-gray-900 font-bold py-4 rounded-xl shadow-lg hover:bg-gray-100 transition-all flex items-center justify-center gap-3">
            <i class="fa-brands fa-google text-xl"></i>
            <span>Googleでログイン</span>
        </button>
        <p class="mt-6 text-xs text-gray-600">Syncs with Firebase Cloud</p>
    </div>

    <!-- ================= APP HEADER ================= -->
    <header class="sticky top-0 z-40 bg-gray-900/90 backdrop-blur-md border-b border-gray-800 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-heart text-brand-accent text-lg"></i>
            <span class="font-serif font-bold text-lg tracking-tight text-gray-100">SmartDate</span>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Sync Status -->
            <div id="sync-status" class="text-xs font-mono text-gray-500 flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-gray-600"></span> Offline
            </div>
            
            <!-- User Menu -->
            <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-800 border border-gray-700 overflow-hidden focus:outline-none focus:ring-2 focus:ring-brand-accent">
                <img id="user-avatar" src="" alt="User" class="w-full h-full object-cover hidden">
                <i id="user-icon-placeholder" class="fa-solid fa-user text-gray-400 text-xs mt-2"></i>
            </button>
        </div>
    </header>

    <!-- ================= MAIN CONTENT ================= -->
    <main class="max-w-md mx-auto px-4 pt-6">
        
        <!-- Hero: Today's Pick -->
        <div id="hero-section" class="relative bg-gradient-to-br from-brand-primary to-gray-800 rounded-3xl p-6 shadow-2xl mb-8 overflow-hidden border border-white/5">
            <div class="absolute top-0 right-0 w-32 h-32 bg-brand-accent/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-brand-accent text-brand-dark text-[10px] font-bold px-2 py-1 rounded-md tracking-wider uppercase">Today's Pick</span>
                    <button onclick="pickRandom()" class="text-white/60 hover:text-white transition-colors"><i class="fa-solid fa-shuffle"></i></button>
                </div>
                <div id="todays-pick-content">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="flex overflow-x-auto gap-2 mb-6 no-scrollbar pb-1" id="category-tabs">
            <!-- Injected by JS -->
        </div>

        <!-- Toolbar (Sort & Count) -->
        <div class="flex justify-between items-center mb-4 px-1">
            <span id="plan-count" class="text-xs font-bold text-gray-500">Loading...</span>
            <div class="flex gap-2">
                <button onclick="toggleSort()" id="sort-btn" class="text-xs font-bold text-gray-400 hover:text-brand-accent transition-colors flex items-center gap-1">
                    <i class="fa-solid fa-arrow-down-short-wide"></i> <span id="sort-label">Budget</span>
                </button>
            </div>
        </div>

        <!-- Plan List -->
        <div id="plan-list" class="space-y-4 min-h-[50vh]">
            <!-- Injected by JS -->
            <div class="text-center py-20 text-gray-600 animate-pulse">
                Loading data from cloud...
            </div>
        </div>

    </main>

    <!-- ================= FOOTER NAV ================= -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur-xl border-t border-gray-800 px-6 py-2 flex justify-center items-center gap-16 z-40 pb-safe">
        <button onclick="switchTab('all')" id="nav-all" class="flex flex-col items-center gap-1 p-2 text-brand-accent transition-all">
            <i class="fa-solid fa-house text-xl"></i>
            <span class="text-[10px] font-bold">Home</span>
        </button>
        <button onclick="switchTab('favorites')" id="nav-fav" class="flex flex-col items-center gap-1 p-2 text-gray-500 hover:text-gray-300 transition-all">
            <i class="fa-solid fa-heart text-xl"></i>
            <span class="text-[10px] font-bold">Likes</span>
        </button>
    </nav>

    <!-- FAB (Add) -->
    <button onclick="openEditor()" class="fixed bottom-24 right-5 z-40 bg-brand-accent text-brand-dark w-14 h-14 rounded-full shadow-lg shadow-brand-accent/20 flex items-center justify-center text-xl hover:bg-yellow-400 transition-transform active:scale-90">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- ================= MODALS ================= -->

    <!-- Editor Modal (Add/Edit) -->
    <div id="editor-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('editor-modal')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-gray-800 rounded-t-3xl p-6 modal-enter max-w-md mx-auto h-[90vh] overflow-y-auto border-t border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 id="editor-title" class="text-xl font-serif font-bold text-gray-100">New Plan</h2>
                <button onclick="closeModal('editor-modal')" class="w-8 h-8 rounded-full bg-gray-700 text-gray-400 flex items-center justify-center hover:bg-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <form id="plan-form" onsubmit="handleSave(event)" class="space-y-5">
                <input type="hidden" name="id">
                
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Spot Name</label>
                    <input type="text" name="name" required class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent focus:ring-1 focus:ring-brand-accent outline-none" placeholder="店名・場所">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Category</label>
                        <select name="category" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none appearance-none">
                            <option>夜ごはん</option><option>休日昼</option><option>遠出</option><option>お家</option><option>季節限定</option><option>お泊まり</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Budget (2人)</label>
                        <input type="number" name="budget" required class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none" placeholder="10000">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Activity</label>
                    <input type="text" name="activity" required class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none" placeholder="何をする？">
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Why (沼らせポイント)</label>
                    <textarea name="why" rows="2" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none" placeholder="おすすめ理由は？"></textarea>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Memo / Links</label>
                    <textarea name="memo" rows="2" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 mt-1 text-gray-200 focus:border-brand-accent outline-none" placeholder="メモやURL（改行区切り）"></textarea>
                </div>

                <div class="flex items-center gap-3 p-4 bg-gray-900 rounded-xl border border-gray-700">
                    <input type="checkbox" name="isChoco" id="chk-choco" class="w-5 h-5 accent-brand-accent rounded">
                    <label for="chk-choco" class="text-sm font-bold text-brand-primary cursor-pointer flex items-center gap-2">
                        <i class="fa-solid fa-mug-hot"></i> チョコ・スイーツ関連
                    </label>
                </div>

                <button type="submit" class="w-full bg-brand-accent text-brand-dark font-bold py-4 rounded-xl shadow-lg mt-4 active:scale-95 transition-transform">
                    <i class="fa-solid fa-save mr-2"></i> Save Plan
                </button>
            </form>
        </div>
    </div>

    <!-- Settings Modal (Sync & Import) -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('settings-modal')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-gray-800 rounded-t-3xl p-6 modal-enter max-w-md mx-auto border-t border-gray-700">
            <h2 class="text-xl font-serif font-bold text-gray-100 mb-6">Settings</h2>

            <!-- Shared ID Config -->
            <div class="mb-8">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">パートナーと同期</label>
                <div class="p-4 bg-gray-900 rounded-xl border border-gray-700">
                    <p class="text-xs text-gray-400 mb-2">あなたのID (これを相手に伝えてください):</p>
                    <div class="flex items-center gap-2 mb-4">
                        <code id="my-uid-display" class="flex-1 bg-black p-2 rounded text-xs font-mono text-brand-accent truncate select-all">...</code>
                        <button onclick="copyUid()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-copy"></i></button>
                    </div>

                    <p class="text-xs text-gray-400 mb-2">相手のIDを入力して同期:</p>
                    <div class="flex gap-2">
                        <input type="text" id="target-uid-input" class="flex-1 bg-black border border-gray-700 rounded-lg px-3 py-2 text-sm text-white font-mono placeholder-gray-600 outline-none focus:border-brand-accent" placeholder="Partner's UID">
                        <button onclick="setTargetUid()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-xs font-bold text-white transition-colors">接続</button>
                    </div>
                    <p id="connection-status" class="text-[10px] text-brand-accent mt-2 hidden"><i class="fa-solid fa-link"></i> パートナーと接続済み</p>
                </div>
            </div>

            <!-- Import Data -->
            <div class="mb-8">
                 <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">データの一括登録</label>
                 <p class="text-[10px] text-gray-400 mb-2">AIで生成したJSONデータを貼り付けて追加できます。</p>
                 <textarea id="import-json-input" rows="4" class="w-full bg-black border border-gray-700 rounded-lg px-3 py-2 text-xs text-white font-mono placeholder-gray-600 outline-none focus:border-brand-accent mb-2" placeholder='[{"name": "...", "category": "夜ごはん", "budget": 10000}]'></textarea>
                 <button onclick="importJsonData()" class="w-full bg-gray-700 text-gray-300 py-3 rounded-xl hover:bg-gray-600 text-sm font-bold flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-file-import"></i> 貼り付けたデータを取り込む
                 </button>
            </div>

            <button onclick="handleLogout()" class="w-full border border-red-900/50 text-red-400 py-3 rounded-xl hover:bg-red-900/20 text-sm font-bold mt-4">
                <i class="fa-solid fa-right-from-bracket mr-2"></i> ログアウト
            </button>
        </div>
    </div>

    <!-- ================= JAVASCRIPT ================= -->
    <script type="module">
        // --- FIREBASE CONFIGURATION (ここに自分の設定を貼り付け) ---
        const firebaseConfig = {
  apiKey: "AIzaSyCh6ml98fmFPvPptdYQcPnOLc06kK7uVCQ",
  authDomain: "dateplan-38034.firebaseapp.com",
  projectId: "dateplan-38034",
  storageBucket: "dateplan-38034.firebasestorage.app",
  messagingSenderId: "243893644952",
  appId: "1:243893644952:web:2a0953206d782a9965eaed"
};
        // --------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Global State
        window.state = {
            user: null,         // Login User
            targetUid: null,    // Data Source UID (Self or Partner)
            data: { plans: [] },// Application Data
            filter: 'すべて',
            sortBy: 'budget', // 'budget' | 'budget-desc'
            viewMode: 'all',  // 'all' | 'favorites'
            unsubscribe: null // Firestore listener
        };

        // --- Firebase Init ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error (Check Config):", e);
            alert("Firebase設定が正しくありません。HTMLソースコード内のfirebaseConfigを編集してください。");
        }

        // --- Auth Logic ---
        const provider = new GoogleAuthProvider();
        const loginBtn = document.getElementById('login-btn');
        const authOverlay = document.getElementById('auth-overlay');

        loginBtn.addEventListener('click', async () => {
            try {
                loginBtn.innerHTML = '<div class="loader"></div>';
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                let errorMessage = `ログインエラー: ${error.message}`;
                
                // 承認されていないドメインからのアクセス時のエラーハンドリング
                if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = "【設定エラー】\nこのサイトのURLがFirebaseの「承認済みドメイン」に登録されていません。\n\nFirebase Consoleを開き、「Authentication」→「Settings（設定）」→「Authorized domains（承認済みドメイン）」に現在のURLを追加してください。";
                }
                
                alert(errorMessage);
                loginBtn.innerHTML = '<i class="fa-brands fa-google text-xl"></i><span>Googleでログイン</span>';
            }
        });

        window.handleLogout = async () => {
            if (window.state.unsubscribe) window.state.unsubscribe(); // Stop listening
            await signOut(auth);
            closeModal('settings-modal');
        };

        onAuthStateChanged(auth, (user) => {
            window.state.user = user;
            if (user) {
                // Logged In
                authOverlay.classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('user-avatar').src = user.photoURL;
                document.getElementById('user-avatar').classList.remove('hidden');
                document.getElementById('user-icon-placeholder').classList.add('hidden');
                document.getElementById('my-uid-display').textContent = user.uid;
                
                // Determine Target UID (Load from localStorage if partner set)
                const savedTarget = localStorage.getItem('smartDate_targetUid');
                window.state.targetUid = savedTarget || user.uid;
                
                if (savedTarget && savedTarget !== user.uid) {
                    document.getElementById('target-uid-input').value = savedTarget;
                    document.getElementById('connection-status').classList.remove('hidden');
                }

                initFirestoreSync();
            } else {
                // Logged Out
                authOverlay.classList.remove('opacity-0', 'pointer-events-none');
                window.state.data = { plans: [] };
                render();
            }
        });

        // --- Firestore Logic (Cloud Wrapper) ---
        function initFirestoreSync() {
            if (!window.state.user) return;
            
            updateSyncStatus('Syncing...', 'yellow');
            
            // Unsubscribe previous listener if exists
            if (window.state.unsubscribe) window.state.unsubscribe();

            // Document Path: users/{targetUid}/appData/v1
            const docRef = doc(db, "users", window.state.targetUid, "appData", "v1");

            window.state.unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // JSON parse logic (if stored as string, though Firestore handles object map fine)
                    // Requirements said "JSON stringify", but Firestore map is better. Let's support object directly.
                    const cloudData = docSnap.data();
                    window.state.data = cloudData.json ? JSON.parse(cloudData.json) : { plans: [] };
                    updateSyncStatus('Synced', 'green');
                } else {
                    // No data yet
                    window.state.data = { plans: [] };
                    updateSyncStatus('No Data', 'gray');
                }
                render();
            }, (error) => {
                console.error("Firestore Error:", error);
                if (error.code === 'permission-denied') {
                     alert("データへのアクセス権がありません。共有設定を確認してください。");
                     updateSyncStatus('Error', 'red');
                }
            });
        }

        async function saveDataToCloud() {
            if (!window.state.user) return;
            updateSyncStatus('保存中...', 'yellow');
            
            try {
                const docRef = doc(db, "users", window.state.targetUid, "appData", "v1");
                const payload = {
                    json: JSON.stringify(window.state.data),
                    updatedAt: new Date(),
                    updatedBy: window.state.user.uid
                };
                await setDoc(docRef, payload);
            } catch (error) {
                console.error("Save Error:", error);
                alert("保存に失敗しました。");
                updateSyncStatus('エラー', 'red');
            }
        }

        // --- App Logic ---
        
        window.importJsonData = async () => {
            const inputEl = document.getElementById('import-json-input');
            const jsonStr = inputEl.value.trim();
            if (!jsonStr) {
                alert("JSONデータを貼り付けてください。");
                return;
            }

            try {
                const newPlans = JSON.parse(jsonStr);
                if (!Array.isArray(newPlans)) {
                    throw new Error("データは配列（[ ]）で囲まれている必要があります。");
                }

                if(confirm(`${newPlans.length}件のデータを取り込みますか？(既存のデータに追加されます)`)) {
                    const currentIds = new Set(window.state.data.plans.map(p => p.id));
                    
                    // 重複排除と簡易バリデーション
                    const validPlans = newPlans.filter(p => {
                        if(!p.name) return false; // 名前がないデータは弾く
                        // IDがない場合は自動付与
                        if (!p.id) p.id = Date.now() + Math.floor(Math.random() * 1000);
                        return !currentIds.has(p.id);
                    });

                    window.state.data.plans = [...window.state.data.plans, ...validPlans];
                    await saveDataToCloud();
                    inputEl.value = ''; // 入力欄をクリア
                    closeModal('settings-modal');
                    alert(`${validPlans.length}件のデータを取り込みました。`);
                }
            } catch (e) {
                alert(`JSONの形式が正しくありません。\nエラー詳細: ${e.message}`);
            }
        };

        window.handleSave = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const newPlan = {
                id: formData.get('id') ? parseInt(formData.get('id')) : Date.now(),
                name: formData.get('name'),
                category: formData.get('category'),
                budget: parseInt(formData.get('budget')),
                activity: formData.get('activity'),
                why: formData.get('why'),
                memo: formData.get('memo'),
                isChoco: form.querySelector('[name=isChoco]').checked,
                done: false, // Default
                likes: []    // UIDs
            };

            const existingIdx = window.state.data.plans.findIndex(p => p.id === newPlan.id);
            if (existingIdx >= 0) {
                // Update (Keep likes/done status)
                newPlan.likes = window.state.data.plans[existingIdx].likes;
                newPlan.done = window.state.data.plans[existingIdx].done;
                window.state.data.plans[existingIdx] = newPlan;
            } else {
                // Add
                window.state.data.plans.unshift(newPlan);
            }

            await saveDataToCloud();
            closeModal('editor-modal');
        };

        window.toggleLike = async (id) => {
            const plan = window.state.data.plans.find(p => p.id === id);
            const uid = window.state.user.uid;
            if (!plan.likes) plan.likes = [];
            
            if (plan.likes.includes(uid)) {
                plan.likes = plan.likes.filter(u => u !== uid);
            } else {
                plan.likes.push(uid);
            }
            await saveDataToCloud(); // render handled by snapshot
        };

        window.toggleDone = async (id) => {
            const plan = window.state.data.plans.find(p => p.id === id);
            plan.done = !plan.done;
            await saveDataToCloud();
        };

        window.deletePlan = async (id) => {
            if(confirm('削除しますか？')) {
                window.state.data.plans = window.state.data.plans.filter(p => p.id !== id);
                await saveDataToCloud();
            }
        };

        // --- Settings Logic ---
        window.copyUid = () => {
            const uid = document.getElementById('my-uid-display').innerText;
            navigator.clipboard.writeText(uid);
            alert('Copied ID!');
        };

        window.setTargetUid = () => {
            const input = document.getElementById('target-uid-input').value.trim();
            if (input) {
                window.state.targetUid = input;
                localStorage.setItem('smartDate_targetUid', input);
                alert('接続先を変更しました。再同期します。');
                initFirestoreSync(); // Reload with new ID
                closeModal('settings-modal');
            }
        };

        // --- UI Rendering ---
        const categories = ['すべて', '夜ごはん', '休日昼', '遠出', 'お家', '季節限定', 'お泊まり'];

        function render() {
            renderTabs();
            renderList();
        }

        function renderTabs() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = categories.map(cat => `
                <button onclick="setFilter('${cat}')" 
                    class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition-all border ${window.state.filter === cat ? 'bg-brand-primary text-brand-accent border-brand-accent' : 'bg-gray-800 text-gray-400 border-gray-700'}">
                    ${cat}
                </button>
            `).join('');
        }

        function renderList() {
            let list = [...window.state.data.plans];
            
            // Filter
            if (window.state.filter !== 'すべて') {
                list = list.filter(p => p.category === window.state.filter);
            }
            if (window.state.viewMode === 'favorites') {
                list = list.filter(p => p.likes && p.likes.includes(window.state.user.uid));
            }

            // Sort
            if (window.state.sortBy === 'budget') list.sort((a,b) => a.budget - b.budget);
            if (window.state.sortBy === 'budget-desc') list.sort((a,b) => b.budget - a.budget);

            // Update Counts
            document.getElementById('plan-count').textContent = `${list.length} Plans`;
            const container = document.getElementById('plan-list');
            
            if (list.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-600"><p>No plans found.</p></div>`;
                return;
            }

            container.innerHTML = list.map(plan => {
                const isLiked = plan.likes && plan.likes.includes(window.state.user.uid);
                const isDone = plan.done;
                
                return `
                <div class="fade-in bg-gray-800 rounded-2xl overflow-hidden border ${isDone ? 'border-green-800 opacity-80' : 'border-gray-700'} relative group">
                    <!-- Image/Color Banner -->
                    <div class="h-24 ${plan.isChoco ? 'bg-[#3E2723]' : 'bg-gray-700'} relative overflow-hidden">
                        ${plan.isChoco ? '<div class="absolute inset-0 opacity-20 bg-[url(\'https://www.transparenttextures.com/patterns/cubes.png\')]"></div>' : ''}
                        <div class="absolute top-2 left-3 flex gap-2">
                             <span class="text-[10px] font-bold bg-gray-900/80 text-gray-300 px-2 py-1 rounded backdrop-blur-sm">${plan.category}</span>
                             ${plan.isChoco ? '<span class="text-[10px] font-bold bg-brand-accent text-brand-dark px-2 py-1 rounded"><i class="fa-solid fa-mug-hot"></i> CHOCO</span>' : ''}
                        </div>
                        <div class="absolute right-3 top-2 flex gap-2">
                             <button onclick="openEditor(${plan.id})" class="w-7 h-7 rounded-full bg-black/40 text-white hover:bg-brand-accent hover:text-brand-dark flex items-center justify-center transition-colors"><i class="fa-solid fa-pencil text-xs"></i></button>
                        </div>
                        ${isDone ? '<div class="absolute inset-0 bg-black/60 flex items-center justify-center"><span class="text-green-400 font-bold border-2 border-green-400 px-3 py-1 rounded transform -rotate-12 text-sm">COMPLETE</span></div>' : ''}
                    </div>

                    <div class="p-4">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-bold text-lg text-gray-100 leading-tight">${plan.name}</h3>
                        </div>
                        
                        <div class="flex items-center gap-4 text-xs text-gray-400 mb-3">
                            <span><i class="fa-solid fa-person-snowboarding text-brand-accent mr-1"></i> ${plan.activity}</span>
                            <span><i class="fa-solid fa-wallet text-brand-accent mr-1"></i> ¥${plan.budget.toLocaleString()}</span>
                        </div>

                        <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700 mb-3">
                            <p class="text-xs text-gray-300"><i class="fa-solid fa-quote-left text-gray-600 mr-1"></i> ${plan.why}</p>
                            ${plan.memo ? `<div class="mt-2 pt-2 border-t border-gray-700 text-[10px] text-gray-500 font-mono">${plan.memo}</div>` : ''}
                        </div>

                        <div class="flex items-center justify-between mt-2">
                            <button onclick="toggleDone(${plan.id})" class="text-xs font-bold ${isDone ? 'text-green-500' : 'text-gray-500 hover:text-gray-300'} flex items-center gap-1 px-2 py-1 rounded hover:bg-gray-700/50 transition-colors">
                                <i class="fa-regular fa-circle-check"></i> ${isDone ? 'Done' : 'Mark Done'}
                            </button>

                            <button onclick="toggleLike(${plan.id})" class="text-xl transition-transform active:scale-125 ${isLiked ? 'text-red-500 icon-pop' : 'text-gray-600 hover:text-gray-400'}">
                                <i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- Helpers ---
        window.setFilter = (cat) => { window.state.filter = cat; render(); };
        window.switchTab = (mode) => { 
            window.state.viewMode = mode; 
            document.getElementById('nav-all').className = mode === 'all' ? 'flex flex-col items-center gap-1 p-2 text-brand-accent transition-all' : 'flex flex-col items-center gap-1 p-2 text-gray-500 hover:text-gray-300 transition-all';
            document.getElementById('nav-fav').className = mode === 'favorites' ? 'flex flex-col items-center gap-1 p-2 text-brand-accent transition-all' : 'flex flex-col items-center gap-1 p-2 text-gray-500 hover:text-gray-300 transition-all';
            render(); 
        };
        window.toggleSort = () => { 
            window.state.sortBy = window.state.sortBy === 'budget' ? 'budget-desc' : 'budget';
            document.getElementById('sort-label').textContent = window.state.sortBy === 'budget' ? 'Budget Low' : 'Budget High';
            render();
        };

        window.openEditor = (id = null) => {
            const form = document.getElementById('plan-form');
            form.reset();
            document.getElementById('editor-title').textContent = id ? 'Edit Plan' : 'New Plan';
            
            if (id) {
                const plan = window.state.data.plans.find(p => p.id === id);
                if (plan) {
                    form.querySelector('[name=id]').value = plan.id;
                    form.querySelector('[name=name]').value = plan.name;
                    form.querySelector('[name=category]').value = plan.category;
                    form.querySelector('[name=budget]').value = plan.budget;
                    form.querySelector('[name=activity]').value = plan.activity;
                    form.querySelector('[name=why]').value = plan.why;
                    form.querySelector('[name=memo]').value = plan.memo || '';
                    form.querySelector('[name=isChoco]').checked = plan.isChoco;
                }
            } else {
                form.querySelector('[name=id]').value = '';
            }
            document.getElementById('editor-modal').classList.remove('hidden');
        };

        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.pickRandom = () => {
            const list = window.state.data.plans;
            if (list.length === 0) return;
            const r = list[Math.floor(Math.random() * list.length)];
            const el = document.getElementById('todays-pick-content');
            el.innerHTML = `
                <h3 class="font-bold text-white text-lg">${r.name}</h3>
                <p class="text-xs text-gray-300 mb-1">${r.activity}</p>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] bg-black/30 px-2 py-1 rounded text-brand-accent">¥${r.budget}</span>
                </div>
            `;
        };

        function updateSyncStatus(msg, color) {
            const el = document.getElementById('sync-status');
            const dot = el.querySelector('span');
            el.innerHTML = `<span class="w-2 h-2 rounded-full bg-${color}-500 mr-1"></span> ${msg}`;
        }

    </script>
</body>
</html>
